<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="referrer" content="no-referrer"/>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>登录跳转</title>
  </head>
  <body>
    <div id="app"></div>
  </body>

  <script>
    function getQueryStringByName(name){
      var result = location.href.match(new RegExp("[?&]" + name+ "=([^&]+)","i"));
      if(result == null || result.length < 1){
          return "";
      }

      return result[1];
    }

    function checkResponse(response, codeHandler) {
      if (!response) {
        return {result: false, msg: "请求异常，响应数据为空"};
      }

      switch (response.code) {
        case 0:
          return {result: true, msg: ""};
        default:
          if (response.message) {
            return {result: false, msg: response.message};
          }
          else {
            var msg = '';
            if (codeHandler) {
              msg = codeHandler(response.code);
            }
            if (msg) {
              return {result: false, msg: msg};
            }
            else {
              return {result: false, msg: defaultCodeHandler(response.code)};
            }
          }
      }
    }

    function init() {
      let code = getQueryStringByName('code');
      if (code == -1) {
        alert('授权登录失败')
        return;
      }
      if (code == 1) {
        alert(getQueryStringByName('msg'))
        return;
      }
  
      let session = getQueryStringByName('session');
      fetch(`https://venyo.cn/resader/user/GetUserInfoBySession?session=${session}`, { method: "GET"})
        .then(function(response) {
          if (response.status == 200) {
              return response.json();
          }
        })
        .then(function(response) {
          let result = checkResponse(response);
            if (result.result) {
              window.localStorage.setItem("user", JSON.stringify(response.data));
              window.location.href = "./";
            }
            else {
              alert(result.msg);
            }
        });
    }

    init();
  </script>
</html>
